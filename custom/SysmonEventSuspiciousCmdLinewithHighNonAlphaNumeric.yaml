id: e9f741a9-8ad4-4e68-83ac-9b2f3b5d12ef
name: Command Line with High Amount of ASCII Non-Alphanumeric Characters
version: 1.0.2
kind: Scheduled
description: Detects suspicious command line activity with a high number of ASCII non-alphanumeric characters, potentially indicative of USB worm activity and behavior associated with Gamarue.
severity: High
queryFrequency: 30m
queryPeriod: 30m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Execution
query: |-
  // Title of Detection:  Command Line with High Amount of Ascii non-alphanumeric characters
  // Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/
  // Description of the Detection:  a decent amount of USB worm activity wherein an exe executes in conjunction with a command line containing non-alphanumeric or otherwise unusual command-line. fp is legit admin activity characters. seen with Gamarue
  // References (if available):  p23  https://resource.redcanary.com/rs/003-YRU-314/images/2021-Threat-Detection-Report.pdf
  // The Logic of the Detection or Query Begins Below This Line
  Event
  | extend ProcessCommandLine = tostring(EventDetails.ProcessCommandLine)
  | where ProcessCommandLine matches regex @"(?i)[-_#~<>]"
  | extend minus = countof(ProcessCommandLine, "-")
  | extend underscore = countof(ProcessCommandLine, "_")
  | extend hash = countof(ProcessCommandLine, "#")
  | extend tilde = countof(ProcessCommandLine, "~")
  | extend lessinequality = countof(ProcessCommandLine, "<")
  | extend moreinequality = countof(ProcessCommandLine, ">")
  | extend Total = minus + underscore + hash + tilde + lessinequality + moreinequality
  | project-reorder TimeGenerated, Computer, UserName, EventID, Image, ProcessCommandLine, minus, underscore, hash, tilde, lessinequality, moreinequality, Total
  | sort by Total desc
  | where Total >= 10
suppressionEnabled: false
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    matchingMethod: AllEntities
    reopenClosedIncident: false
    groupByCustomDetails: []
    groupByEntities: []
    groupByAlertDetails: []
    lookbackDuration: 5h
    enabled: false
eventGroupingSettings:
  aggregationKind: AlertPerResult
customDetails:
  ProcessCommandLine: ProcessCommandLine
  TotalSpecialChars: Total
  ProcessImage: Image
entityMappings:
  - entityType: Account
    fieldMappings:
      - columnName: UserName
        identifier: FullName
  - entityType: Host
    fieldMappings:
      - columnName: Computer
        identifier: HostName
suppressionDuration: 5h
