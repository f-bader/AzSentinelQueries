id: 5f5f0290-f529-461b-bf2f-dbd79348988e
name: Anonymous Retrieval of Azure Blob Versions
version: 1.0.0
kind: Scheduled
description: |-
  This rule detects a sequence of suspicious activities where an unauthenticated (anonymous) source enumerates the version history of a storage blob and subsequently downloads a blob from the same path within a 10-minute window.

  While public access to storage containers may be intentional, attackers frequently target these containers to look for "soft-deleted" data or previous versions of files. They do this to uncover sensitive information (such as hardcoded credentials, API keys, or PII) that may have been present in an older version of a file but removed in the current "live" version.
severity: Low
queryFrequency: 10m
queryPeriod: 22m
triggerOperator: gt
triggerThreshold: 0
tactics:
- Collection
- Exfiltration
relevantTechniques:
- T1530
- T1567
query: |-
  let VersionEnumeration= StorageBlobLogs
      | where AuthenticationType == "Anonymous"
      | where Uri has "include=versions"
      | extend IPAddress = tostring(split(CallerIpAddress, ':')[0])
      | summarize by ObjectKey, EnumerationTimeGenerated=TimeGenerated, IPAddress;
  StorageBlobLogs
  | where AuthenticationType == "Anonymous"
  | extend IPAddress = tostring(split(CallerIpAddress, ':')[0])
  | where OperationName == "GetBlob"
  | extend ObjectKeyJSON = parse_path(ObjectKey)
  | extend ObjectKey = tostring(ObjectKeyJSON.DirectoryPath)
  | extend Filename =  tostring(ObjectKeyJSON.Filename)
  | join kind=inner (VersionEnumeration) on ObjectKey, IPAddress
  | extend TimeDifference = datetime_diff('minute', TimeGenerated, EnumerationTimeGenerated)
  | where TimeDifference between (0 .. 10)
  | where TimeGenerated >= ago(10m) or EnumerationTimeGenerated >= ago(10m)
suppressionEnabled: false
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: 5h
    matchingMethod: AllEntities
    groupByEntities: []
    groupByAlertDetails: []
    groupByCustomDetails: []
eventGroupingSettings:
  aggregationKind: SingleAlert
entityMappings:
- entityType: File
  fieldMappings:
  - identifier: Directory
    columnName: ObjectKey
  - identifier: Name
    columnName: Filename
- entityType: IP
  fieldMappings:
  - identifier: Address
    columnName: IPAddress
suppressionDuration: 5h

